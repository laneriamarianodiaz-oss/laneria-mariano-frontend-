<div class="finalizar-compra">
  <div class="contenedor">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
      <span>inicio > Finalizar compra</span>
    </div>

    <!-- Banner de env√≠o gratis -->
    <div class="banner-envio">
      <span>Env√≠o gratis especial para ti</span>
      <span class="badge-oferta">Oferta exclusiva</span>
    </div>

    <div class="layout-checkout">
      <!-- COLUMNA IZQUIERDA -->
      <div class="columna-principal">
        
        <!-- Direcci√≥n de env√≠o -->
        <div class="seccion">
          <div class="seccion-header">
            <h3>Direcci√≥n de env√≠o</h3>
            <button type="button" class="btn-link" (click)="cambiarDireccion()">
              {{ mostrarFormularioDireccion ? 'Cancelar' : 'Cambiar direccion >' }}
            </button>
          </div>

          <div class="datos-envio" *ngIf="!mostrarFormularioDireccion">
            <p class="nombre">{{ nombreUsuario }}</p>
            <p class="telefono">üìû {{ telefono }}</p>
            <p class="direccion">üìç {{ direccionEnvio }}</p>
          </div>

          <div class="formulario" *ngIf="mostrarFormularioDireccion">
            <div class="form-group">
              <input 
                type="text" 
                [(ngModel)]="direccionEnvio" 
                placeholder="Direcci√≥n de env√≠o"
                class="input-field">
            </div>
            <div class="form-group">
              <input 
                type="tel" 
                [(ngModel)]="telefono" 
                placeholder="Tel√©fono de contacto"
                class="input-field">
            </div>
          </div>
        </div>

        <!-- Productos en env√≠o -->
        <div class="seccion">
          <div class="seccion-header">
            <h3>Env√≠o gratis ({{ cantidadItems }})</h3>
          </div>

          <div class="lista-productos">
            <div class="producto-item" *ngFor="let item of items">
              <img [src]="item.producto.imagen_url || 'assets/imagenes/default.jpg'" 
                   [alt]="item.producto.nombre_producto">
              <div class="producto-info">
                <p class="producto-nombre">{{ item.producto.nombre_producto }}</p>
                <p class="producto-cantidad">Cantidad: {{ item.cantidad }}</p>
              </div>
              S/ {{ ((item.producto.precio_producto || item.producto.precio_unitario || 0) * item.cantidad).toFixed(2) }}
            </div>
          </div>
        </div>

        <!-- M√©todo de pago Yape -->
        <div class="seccion seccion-yape">
          <div class="seccion-header">
            <h3>üí≥ M√©todo de Pago - Yape</h3>
          </div>

          <div class="contenido-yape">
            <!-- Instrucciones -->
            <div class="instrucciones">
              <div class="header-yape">
                <img src="pago/yape.png" alt="Yape" class="logo-yape">
                <div>
                  <h4>Paga con Yape</h4>
                  <p>R√°pido, f√°cil y seguro</p>
                </div>
              </div>

              <div class="pasos">
                <p><strong>Sigue estos pasos:</strong></p>
                <ol>
                  <li>Escanea el c√≥digo QR desde tu app Yape</li>
                  <li>Realiza el pago de <strong>S/ {{ totalArticulos.toFixed(2) }}</strong></li>
                  <li>Toma captura del comprobante</li>
                  <li>Sube la captura y el c√≥digo de operaci√≥n abajo</li>
                </ol>
              </div>
            </div>

            <!-- QR Code -->
            <div class="qr-container">
              <div class="qr-box">
                <img src="pago/qr.jpeg" alt="QR Yape" class="qr-image">
                <p class="qr-monto">S/ {{ totalArticulos.toFixed(2) }}</p>
              </div>
            </div>

            <!-- ‚úÖ FORMULARIO DE COMPROBANTE CORREGIDO -->
            <div class="form-comprobante">
              <div class="form-group">
                <label>Comprobante de pago *</label>
                
                <!-- ‚úÖ Mostrar √°rea de upload si NO hay preview -->
                <div class="upload-area" *ngIf="!previsualizacionComprobante">
                  <input 
                    type="file" 
                    id="comprobante" 
                    accept="image/jpeg,image/jpg,image/png"
                    (change)="onFileSelected($event)"
                    hidden>
                  <label for="comprobante" class="upload-label">
                    <span class="upload-icon">üì∏</span>
                    <span class="upload-text">Haz clic para subir el comprobante</span>
                    <span class="upload-hint">JPG, PNG (m√°x. 5MB)</span>
                  </label>
                </div>

                <!-- ‚úÖ Mostrar preview si hay imagen seleccionada -->
                <div class="preview-box" *ngIf="previsualizacionComprobante">
                  <img [src]="previsualizacionComprobante" alt="Comprobante">
                  <button type="button" class="btn-remove" (click)="eliminarComprobante()">
                    <span>√ó</span>
                  </button>
                </div>
                
                <!-- ‚úÖ Mostrar nombre del archivo -->
                <p class="file-name" *ngIf="comprobanteFile">
                  ‚úÖ Archivo: {{ comprobanteFile.name }}
                </p>
              </div>

              <div class="form-group">
                <label>C√≥digo de operaci√≥n *</label>
                <input 
                  type="text" 
                  [(ngModel)]="codigoOperacion"
                  placeholder="Ingresa el c√≥digo de tu comprobante"
                  class="input-field"
                  maxlength="50">
                <small class="hint">Ejemplo: 001234567890</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- COLUMNA DERECHA - RESUMEN -->
      <div class="columna-resumen">
        <div class="resumen-card">
          <h3>Resumen de tu pedido</h3>

          <div class="resumen-linea">
            <span>Total de articulos:</span>
            <span>S/ {{ totalArticulos.toFixed(2) }}</span>
          </div>

          <div class="resumen-linea">
            <span>Estimaci√≥n total:</span>
            <span>S/ {{ totalArticulos.toFixed(2) }}</span>
          </div>

          <div class="resumen-envio">
            <span>Env√≠o:</span>
            <span class="gratis">Gratis!</span>
          </div>

          <div class="resumen-total">
            <span>Total pedido:</span>
            <span>S/{{ totalArticulos.toFixed(2) }}</span>
          </div>

          <!-- ‚úÖ BOT√ìN CORREGIDO - usa comprobanteFile en lugar de archivoComprobante -->
          <button 
            type="button"
            class="btn-finalizar" 
            (click)="finalizarCompra()"
            [disabled]="cargando || items.length === 0 || !codigoOperacion || !comprobanteFile">
            <span *ngIf="!cargando">Finalizar compra ({{ cantidadItems }})</span>
            <span *ngIf="cargando">
              <span class="spinner">‚è≥</span> Procesando...
            </span>
          </button>
          
          <!-- ‚úÖ MENSAJE DE AYUDA -->
          <p class="help-text" *ngIf="!comprobanteFile || !codigoOperacion">
            ‚ö†Ô∏è Por favor completa el comprobante y c√≥digo de operaci√≥n
          </p>
        </div>
      </div>
    </div>
  </div>
</div>